<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .register-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-wrapper .form-control {
            padding-right: 3rem;
        }

        .password-toggle {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-size: 18px;
            z-index: 10;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            color: #333;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .password-toggle:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control.valid {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        .form-control.invalid {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        .field-errors {
            margin-top: 0.5rem;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .success-message {
            color: #28a745;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }

        .btn-submit {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit:hover:not(:disabled) {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-submit:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .password-strength-meter {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .strength-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .strength-bar-fill {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 3px;
        }

        .strength-weak {
            background: #dc3545;
            width: 25%;
        }

        .strength-fair {
            background: #fd7e14;
            width: 50%;
        }

        .strength-good {
            background: #ffc107;
            width: 75%;
        }

        .strength-strong {
            background: #28a745;
            width: 100%;
        }

        .strength-text {
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .strength-weak-text { color: #dc3545; }
        .strength-fair-text { color: #fd7e14; }
        .strength-good-text { color: #ffc107; }
        .strength-strong-text { color: #28a745; }

        .password-requirements {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }

        .requirement {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .requirement:last-child {
            margin-bottom: 0;
        }

        .requirement-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .requirement-icon.valid {
            background: #28a745;
            color: white;
        }

        .requirement-icon.invalid {
            background: #dc3545;
            color: white;
        }

        .requirement-icon.neutral {
            background: #e9ecef;
            color: #6c757d;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }

        .login-link {
            text-align: center;
            margin-top: 1.5rem;
        }

        .login-link a {
            color: #667eea;
            text-decoration: none;
        }

        .login-link a:hover {
            text-decoration: underline;
        }

        .flash-messages {
            margin-bottom: 1rem;
        }

        .flash-message {
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .flash-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .flash-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="register-container">
        <h1>Sign Up</h1>
        
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <form method="POST" id="registerForm" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="form-group">
                {{ form.first_name.label(class="form-label", for="first_name") }}
                {{ form.first_name(class="form-control", id="first_name", **{"aria-describedby": "first_name_errors", "aria-required": "true", "aria-invalid": "false"}) }}
                <div class="field-errors" id="first_name_errors" role="alert" aria-live="polite"></div>
            </div>

            <div class="form-group">
                {{ form.last_name.label(class="form-label", for="last_name") }}
                {{ form.last_name(class="form-control", id="last_name", **{"aria-describedby": "last_name_errors", "aria-required": "true", "aria-invalid": "false"}) }}
                <div class="field-errors" id="last_name_errors" role="alert" aria-live="polite"></div>
            </div>

            <div class="form-group">
                {{ form.email.label(class="form-label", for="email") }}
                {{ form.email(class="form-control", id="email", **{"aria-describedby": "email_errors", "aria-required": "true", "aria-invalid": "false"}) }}
                <div class="field-errors" id="email_errors" role="alert" aria-live="polite"></div>
            </div>

            <div class="form-group">
                {{ form.password.label(class="form-label", for="password") }}
                <div class="password-input-wrapper">
                    {{ form.password(class="form-control", type="password", id="password", **{"aria-describedby": "password_errors passwordStrengthMeter passwordRequirements", "aria-required": "true", "aria-invalid": "false"}) }}
                    <button type="button" class="password-toggle" id="passwordToggle" aria-label="Toggle password visibility" aria-pressed="false">
                        <span aria-hidden="true">üëÅÔ∏è</span>
                    </button>
                </div>
                
                <div class="password-strength-meter" id="passwordStrengthMeter" style="display: none;" role="status" aria-live="polite">
                    <div class="strength-bar" role="progressbar" aria-valuemin="0" aria-valuemax="7" aria-valuenow="0" aria-label="Password strength">
                        <div class="strength-bar-fill" id="strengthBarFill"></div>
                    </div>
                    <div class="strength-text" id="strengthText">
                        <span id="strengthLabel">Password Strength</span>
                        <span id="strengthScore">0/7</span>
                    </div>
                </div>
                
                <div class="field-errors" id="password_errors" role="alert" aria-live="polite"></div>
                
                <div class="password-requirements" id="passwordRequirements" style="display: none;" role="region" aria-label="Password requirements">
                    <h3 id="passwordRequirementsTitle" class="sr-only">Password Requirements</h3>
                    <ul role="list" aria-labelledby="passwordRequirementsTitle">
                        <li class="requirement" id="req-length" role="listitem">
                            <span class="requirement-icon neutral" aria-hidden="true">‚Ä¢</span>
                            <span>At least 12 characters</span>
                        </li>
                        <li class="requirement" id="req-uppercase" role="listitem">
                            <span class="requirement-icon neutral" aria-hidden="true">‚Ä¢</span>
                            <span>One uppercase letter</span>
                        </li>
                        <li class="requirement" id="req-lowercase" role="listitem">
                            <span class="requirement-icon neutral" aria-hidden="true">‚Ä¢</span>
                            <span>One lowercase letter</span>
                        </li>
                        <li class="requirement" id="req-number" role="listitem">
                            <span class="requirement-icon neutral" aria-hidden="true">‚Ä¢</span>
                            <span>One number</span>
                        </li>
                        <li class="requirement" id="req-symbol" role="listitem">
                            <span class="requirement-icon neutral" aria-hidden="true">‚Ä¢</span>
                            <span>One symbol (!@#$%^&*()_+-=[]{}|;:,.<>?)</span>
                        </li>
                        <li class="requirement" id="req-repeat" role="listitem">
                            <span class="requirement-icon neutral" aria-hidden="true">‚Ä¢</span>
                            <span>No 3+ repeated characters</span>
                        </li>
                        <li class="requirement" id="req-email-diff" role="listitem">
                            <span class="requirement-icon neutral" aria-hidden="true">‚Ä¢</span>
                            <span>Differ from email by 5+ characters</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="form-group">
                {{ form.confirm_password.label(class="form-label", for="confirm_password") }}
                <div class="password-input-wrapper">
                    {{ form.confirm_password(class="form-control", type="password", id="confirm_password", **{"aria-describedby": "confirm_password_errors", "aria-required": "true", "aria-invalid": "false"}) }}
                    <button type="button" class="password-toggle" id="confirmPasswordToggle" aria-label="Toggle confirm password visibility" aria-pressed="false">
                        <span aria-hidden="true">üëÅÔ∏è</span>
                    </button>
                </div>
                <div class="field-errors" id="confirm_password_errors" role="alert" aria-live="polite"></div>
            </div>

            <div class="form-group">
                {{ form.submit(class="btn-submit", disabled=true, id="submitBtn") }}
            </div>
        </form>

        <div class="login-link">
            <a href="{{ url_for('login') }}">Already have an account? Login</a>
        </div>
    </div>

    <script>
        class FormValidator {
            constructor() {
                this.form = document.getElementById('registerForm');
                this.submitBtn = document.getElementById('submitBtn');
                this.fields = {
                    first_name: document.getElementById('first_name'),
                    last_name: document.getElementById('last_name'),
                    email: document.getElementById('email'),
                    password: document.getElementById('password'),
                    confirm_password: document.getElementById('confirm_password')
                };
                this.fieldStates = {};
                this.passwordVisible = false;
                this.confirmPasswordVisible = false;
                this.init();
            }

            init() {
                Object.keys(this.fields).forEach(fieldName => {
                    const field = this.fields[fieldName];
                    this.fieldStates[fieldName] = { valid: false, errors: [] };
                    
                    field.addEventListener('input', () => this.validateField(fieldName));
                    field.addEventListener('blur', () => this.validateField(fieldName));
                    
                    if (fieldName === 'password') {
                        field.addEventListener('focus', () => this.showPasswordRequirements());
                        field.addEventListener('input', () => {
                            this.updatePasswordRequirements();
                            this.updatePasswordStrength();
                        });
                    }
                });

                // Initialize password toggle buttons
                this.initPasswordToggles();
                this.updateSubmitButton();
            }

            initPasswordToggles() {
                const passwordToggle = document.getElementById('passwordToggle');
                const confirmPasswordToggle = document.getElementById('confirmPasswordToggle');

                passwordToggle.addEventListener('click', () => this.togglePasswordVisibility('password'));
                confirmPasswordToggle.addEventListener('click', () => this.togglePasswordVisibility('confirm_password'));
                
                // Add keyboard support for password toggles
                passwordToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.togglePasswordVisibility('password');
                    }
                });
                
                confirmPasswordToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.togglePasswordVisibility('confirm_password');
                    }
                });
            }

            togglePasswordVisibility(fieldName) {
                const field = this.fields[fieldName];
                const toggleBtn = fieldName === 'password' 
                    ? document.getElementById('passwordToggle')
                    : document.getElementById('confirmPasswordToggle');

                if (fieldName === 'password') {
                    this.passwordVisible = !this.passwordVisible;
                    field.type = this.passwordVisible ? 'text' : 'password';
                    const icon = toggleBtn.querySelector('span[aria-hidden="true"]');
                    icon.textContent = this.passwordVisible ? 'üôà' : 'üëÅÔ∏è';
                    toggleBtn.setAttribute('aria-pressed', this.passwordVisible.toString());
                    toggleBtn.setAttribute('aria-label', 
                        this.passwordVisible ? 'Hide password' : 'Show password');
                } else {
                    this.confirmPasswordVisible = !this.confirmPasswordVisible;
                    field.type = this.confirmPasswordVisible ? 'text' : 'password';
                    const icon = toggleBtn.querySelector('span[aria-hidden="true"]');
                    icon.textContent = this.confirmPasswordVisible ? 'üôà' : 'üëÅÔ∏è';
                    toggleBtn.setAttribute('aria-pressed', this.confirmPasswordVisible.toString());
                    toggleBtn.setAttribute('aria-label', 
                        this.confirmPasswordVisible ? 'Hide confirm password' : 'Show confirm password');
                }
            }

            showPasswordRequirements() {
                document.getElementById('passwordRequirements').style.display = 'block';
                document.getElementById('passwordStrengthMeter').style.display = 'block';
            }

            calculatePasswordStrength(password) {
                const email = this.fields.email.value;
                const emailLocal = email.split('@')[0];

                const requirements = {
                    length: password.length >= 12,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    symbol: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password),
                    noRepeat: !this.hasRepeatedChars(password),
                    emailDiff: this.checkEmailDifference(password, emailLocal)
                };

                const metCount = Object.values(requirements).filter(Boolean).length;
                
                let strength = 'weak';
                let strengthClass = 'strength-weak';
                let strengthTextClass = 'strength-weak-text';

                if (metCount >= 6) {
                    strength = 'strong';
                    strengthClass = 'strength-strong';
                    strengthTextClass = 'strength-strong-text';
                } else if (metCount >= 5) {
                    strength = 'good';
                    strengthClass = 'strength-good';
                    strengthTextClass = 'strength-good-text';
                } else if (metCount >= 3) {
                    strength = 'fair';
                    strengthClass = 'strength-fair';
                    strengthTextClass = 'strength-fair-text';
                }

                return {
                    requirements,
                    metCount,
                    strength,
                    strengthClass,
                    strengthTextClass
                };
            }

            updatePasswordStrength() {
                const password = this.fields.password.value;
                const strengthMeter = document.getElementById('passwordStrengthMeter');
                const strengthBarFill = document.getElementById('strengthBarFill');
                const strengthBar = strengthMeter.querySelector('[role="progressbar"]');
                const strengthLabel = document.getElementById('strengthLabel');
                const strengthScore = document.getElementById('strengthScore');

                if (!password) {
                    strengthMeter.style.display = 'none';
                    return;
                }

                const analysis = this.calculatePasswordStrength(password);
                
                // Update strength bar with proper ARIA attributes
                strengthBarFill.className = `strength-bar-fill ${analysis.strengthClass}`;
                strengthBar.setAttribute('aria-valuenow', analysis.metCount);
                strengthBar.setAttribute('aria-valuetext', `Password strength: ${analysis.strength}, ${analysis.metCount} of 7 requirements met`);
                
                // Update strength text
                strengthLabel.textContent = `Password Strength: ${analysis.strength.charAt(0).toUpperCase() + analysis.strength.slice(1)}`;
                strengthLabel.className = analysis.strengthTextClass;
                strengthScore.textContent = `${analysis.metCount}/7`;
                strengthScore.className = analysis.strengthTextClass;
            }

            updatePasswordRequirements() {
                const password = this.fields.password.value;
                const email = this.fields.email.value;
                const emailLocal = email.split('@')[0];

                const requirements = {
                    'req-length': password.length >= 12,
                    'req-uppercase': /[A-Z]/.test(password),
                    'req-lowercase': /[a-z]/.test(password),
                    'req-number': /\d/.test(password),
                    'req-symbol': /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password),
                    'req-repeat': !this.hasRepeatedChars(password),
                    'req-email-diff': this.checkEmailDifference(password, emailLocal)
                };

                Object.keys(requirements).forEach(reqId => {
                    const element = document.getElementById(reqId);
                    const icon = element.querySelector('.requirement-icon');
                    const text = element.querySelector('span:not(.requirement-icon)');
                    
                    if (requirements[reqId]) {
                        icon.className = 'requirement-icon valid';
                        icon.textContent = '‚úì';
                        element.setAttribute('aria-label', `${text.textContent} - met`);
                    } else {
                        icon.className = 'requirement-icon invalid';
                        icon.textContent = '‚úï';
                        element.setAttribute('aria-label', `${text.textContent} - not met`);
                    }
                });
            }

            hasRepeatedChars(str) {
                for (let i = 0; i < str.length - 2; i++) {
                    if (str[i] === str[i+1] && str[i] === str[i+2]) {
                        return true;
                    }
                }
                return false;
            }

            checkEmailDifference(password, emailLocal) {
                if (!emailLocal || emailLocal.length === 0) return password.length >= 5;
                
                const pwd = password.toLowerCase();
                const email = emailLocal.toLowerCase();
                
                let differences = 0;
                const minLen = Math.min(pwd.length, email.length);
                
                for (let i = 0; i < minLen; i++) {
                    if (pwd[i] !== email[i]) differences++;
                }
                
                differences += Math.abs(pwd.length - email.length);
                return differences >= 5;
            }

            async validateField(fieldName) {
                const field = this.fields[fieldName];
                const value = field.value.trim();
                const errors = [];

                // Basic validation
                if (!value && fieldName !== 'confirm_password') {
                    errors.push(`${fieldName.replace('_', ' ')} is required`);
                }

                // Field-specific validation
                if (value) {
                    switch (fieldName) {
                        case 'first_name':
                        case 'last_name':
                            if (value.length > 50) errors.push('Must be 50 characters or less');
                            break;
                        
                        case 'email':
                            if (!value.endsWith('@getcovered.io')) {
                                errors.push('Email must be a @getcovered.io address');
                            }
                            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                                errors.push('Invalid email format');
                            }
                            break;
                        
                        case 'password':
                            errors.push(...this.validatePassword(value));
                            break;
                        
                        case 'confirm_password':
                            if (value !== this.fields.password.value) {
                                errors.push('Passwords do not match');
                            }
                            break;
                    }
                }

                this.fieldStates[fieldName] = {
                    valid: errors.length === 0 && (value || fieldName === 'confirm_password'),
                    errors: errors
                };

                this.updateFieldUI(fieldName, errors);
                this.updateSubmitButton();
            }

            validatePassword(password) {
                const errors = [];
                const email = this.fields.email.value;
                const emailLocal = email.split('@')[0];

                if (password.length < 12) errors.push('Must be at least 12 characters');
                if (!/[A-Z]/.test(password)) errors.push('Must contain uppercase letter');
                if (!/[a-z]/.test(password)) errors.push('Must contain lowercase letter');
                if (!/\d/.test(password)) errors.push('Must contain a number');
                if (!/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) errors.push('Must contain a symbol');
                if (this.hasRepeatedChars(password)) errors.push('Cannot have 3+ repeated characters');
                if (!this.checkEmailDifference(password, emailLocal)) {
                    errors.push('Must differ from email by 5+ characters');
                }

                return errors;
            }

            updateFieldUI(fieldName, errors) {
                const field = this.fields[fieldName];
                const errorsContainer = document.getElementById(`${fieldName}_errors`);
                
                errorsContainer.innerHTML = '';
                
                if (errors.length > 0) {
                    field.classList.add('invalid');
                    field.classList.remove('valid');
                    field.setAttribute('aria-invalid', 'true');
                    
                    errors.forEach(error => {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = error;
                        errorsContainer.appendChild(errorDiv);
                    });
                } else if (field.value.trim()) {
                    field.classList.add('valid');
                    field.classList.remove('invalid');
                    field.setAttribute('aria-invalid', 'false');
                    
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success-message';
                    successDiv.textContent = '‚úì Valid';
                    errorsContainer.appendChild(successDiv);
                } else {
                    field.classList.remove('valid', 'invalid');
                    field.setAttribute('aria-invalid', 'false');
                }
            }

            updateSubmitButton() {
                const allValid = Object.values(this.fieldStates).every(state => state.valid);
                const allFilled = Object.keys(this.fields).every(fieldName => 
                    this.fields[fieldName].value.trim() !== ''
                );

                this.submitBtn.disabled = !(allValid && allFilled);
            }
        }

        // Initialize form validator when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new FormValidator();
        });
    </script>
</body>
</html>